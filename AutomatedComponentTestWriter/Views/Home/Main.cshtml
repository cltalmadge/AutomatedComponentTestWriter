@{
    ViewData["Title"] = "Automated Component Test Writer";

}
@using System.Linq
@using AutomatedComponentTestWriter.Models
@model AutomatedComponentTestWriter.Models.ComponentTestDTO
<!DOCTYPE html>
<div class="form-group">
    <label for="json object">Input JSON object:</label>
    <textarea id="JSONTextArea" class="form-control" rows="10" cols="10"></textarea>
    <table>
        <tr>
            <td>
                <label class="btn btn-outline-primary" for="fileToLoad">
                    <input type="file" id="fileToLoad" accept=".JSON" style="display:none">Browse
                </label>
            </td>
            <td><button id="loadJSON" class="btn btn-primary" onclick="loadFileAsText()">Load Selected File</button></td>
            <td><button class="btn btn-lg" onclick="JSONtoHTML()">Submit</button></td>
        </tr>
    </table>
</div>
<div id="jsonErrField"></div> <!--This is where I am putting any error messages regarding JSON parsing after it is submitted to the application.-->
@using (Html.BeginForm("ReadDTO", "Home"))
{
<div id="mainGUI">
    <div class="panel panel-default">
        <div class="panel-heading"><strong>Object Details</strong></div>
        <label>API Action:</label>@Html.DropDownListFor(model => model.APIAction,
                                                    new SelectList(Enum.GetValues(typeof(APIAction))),
                                                    "Select API Action . . . ",
                                                    new { @class = "form-control"})
        <label>URI/URL:</label>@Html.TextBoxFor(model => model.APIEndpointURL, new { @class = "form-control"}) 
        <div class="panel-body">
            <div class="scrollbar">
                <table class="table table-bordered">
                    <tr>
                        <th>Property Name</th>
                        <th>Data Type</th>
                        <th>Required</th>
                        <th>Default Value</th>
                        <th></th>
                    </tr>
                    <tbody id="AttributeTable">
                        @*<tr>
                            <td style="display:none"><input type="hidden" name="Properties.Index" value="0" /></td>
                            <td><label id="Properties_0_PropertyName" name="Properties[0].PropertyName">TestProperty</label></td>
                            <td>
                                <select class="form-control" id="Properties_0_DataType" name="Properties[0].DataType">
                                    <option>Select Type . . .</option>
                                    <option>string</option>
                                    <option>bool</option>
                                    <option>int</option>
                                    <option>decimel</option>
                                    <option>DateTime</option>
                                    <option>Complex</option>
                                </select>
                            </td>
                            <td>
                               </td>
                            <td><input class="form-control" type="text" id="Properties_0_DefaultValue" name="Properties[0].DefaultValue" /></td>
                            <td>
                                <button id="modalActivate" type="button" class="btn btn-danger" data-toggle="modal" data-target="#Properties_0_Preferences">🖉 Edit Parameters</button>
                                <div class="modal fade right" id="Properties_0_Preferences" tabindex="-1" role="dialog" aria-labelledby="Properties_0_PreferencesPreviewLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalPreviewLabel">Preferences for Property: </h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div id="ParameterMenu">
                                                    <div class="panel-body">
                                                        <table  class="table table-striped">
                                                            <tr><th>Expected Message</th><th>HTTP Response</th><th>Random</th><th>Null</th><th>Blank</th><th>Value/Char Length</th><th>Test Name</th><th><button type="button" class="btn btn-success" onclick="addParam('Properties_0_ParameterTable')">+ Add Parameter</button></th></tr>
                                                            <tbody id="Properties_0_ParameterTable">
                                                                <tr>
                                                                    <td style="display:none">
                                                                        <input type="hidden" name="Properties[0].Attributes.Index" value="0" />
                                                                    </td>
                                                                    <td>
                                                                        <input class="form-control" type="text" id="Property_0_Param_0_Expected_message" name="Properties[0].Parameters[0].ExpectedMessage" />
                                                                    </td>
                                                                    <td>
                                                                        <select class="form-control" id="Property_0_Param_0_HTTPResponse" name="Properties[0].Parameters[0].HTTPResponse">
                                                                            <option>Select . . . </option>
                                                                            <option>BadRequest</option>
                                                                            <option>Unauthorized</option>
                                                                            <option>NotFound</option>
                                                                            <option>OK</option>
                                                                            <option>InternalServerError</option>
                                                                        </select>
                                                                    </td>
                                                                    <td>
                                                                        
                                                                    </td>
                                                                    <td>
                                                                        
                                                                    </td>
                                                                    <td>
                                                                        
                                                                    </td>
                                                                    <td>
                                                                        <input class="form-control" type="text" id="Property_0_Param_0_ValueLength" name="Properties[0].Parameters[0].ValueLength" />
                                                                    </td>
                                                                    <td>
                                                                        <input class="form-control" type="text" id="Property_0_Param_0_TestName" name="Properties[0].Parameters[0].TestName" />
                                                                    </td>
                                                                    <td>
                                                                        <button type="button" class="btn btn-danger" onclick="deleterow(this)">x</button>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Done</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>*@
                    </tbody>
                </table>
            </div>
        </div>
        <div class="panel-footer"><input type="submit" value="Heck"/></div>
    </div>
    @*<div class="panel panel-default">
            <div class="panel-heading">Object Details</div>
            <form action="post">
                <div class="panel-body">
                    <div class="form-group">
                        <label for="exampleFormControlSelect1">Post Type</label>
                        <select class="form-control" id="selectAPIAction">
                            <option>Select API Action . . . </option>
                            <option>API POST</option>
                            <option>API PUT</option>
                        </select>
                        <div class="form-group">
                            <label for="exampleFormControlInput1">URI/URL</label>
                            <input type="url" class="form-control" id="APIendpointURL" placeholder="www.yourendpoint.com">
                        </div>
                    </div>
                    <div class="scrollbar">
                        <table class="table table-striped">
                            <tr><th>Property Name</th><th>Data Type</th><th>Required</th><th>Default Value</th><th></th></tr>
                        </table>
                    </div>
                </div>
                <div class="panel-footer">
                    <label for="dtoName">DTO Name</label><input name="dtoName" class="form-control" />
                    <button class="btn btn-success">&#9658; Run Now</button>
                </div>
            </form>
        </div>*@
</div>
}

<!--Load in the js last.-->
<script src="~/Scripts/main.js">

</script>
<script>
    function deleteRow(btn) {
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }
    function addParam(tagID) {
        //var string = "" + tagID;
        //var splitThatBoi = string.split("_");
        //console.log(splitThatBoi[0]);
        var numrowsintable = $(`#${tagID}`).children("tr").length;
        $(document).ready(function () {
            console.log(newrowno);
            $(`#${tagid}`).append(`<tr><td><div class="form-group"><input name="${tagid}parameters_row${newrowno}_expectedmessage" class= "form-control" ></div ></td > <td><div class="form-group"><select name="${tagid}parameters_row${newrowno}_httpresponse" class="form-control"><option>select . . .</option><option>badrequest</option><option>unauthorized</option><option>notfound</option><option>ok</option><option>internalservererror</option></select></div></td> <td><div class="form-group"><input name="${tagid}parameters_row${newrowno}_checkedrandom" type="checkbox" /></div></td> <td><div class="form-group"><input type="checkbox" name="${tagid}parameters_row${newrowno}_checkednull" /></div></td> <td><div class="form-group"><input type="checkbox" name="${tagid}parameters_row${newrowno}_checkedblank" /></div></td> <td><div class="form-group"><input name="${tagid}parameters_row${newrowno}_valuelength" class="form-control" /></div></td> <td><div class="form-group"><input name="${tagid}parameters_row${newrowno}_testname" class="form-control" /></div></td> <td><button type="button" class="btn btn-danger" onclick="deleterow(this)">x</button></td></tr >
        `);
        });
    }

    function JSONtoHTML() {
        console.time('jsonLoadTime');
        var theJSON = document.getElementById("JSONTextArea").value;
        var printError = function (error, explicit) {
            var err = `[${explicit ? 'EXPLICIT' : 'INEXPLICIT'}] ${error.name}: ${error.message}`;
            $(document).ready(function () {
                $("#jsonErrField").html(`<div class="alert alert-danger">"${err}"</div>`);
            });
        }
            var html = "";
        try {
            var json = JSON.parse(theJSON);
            console.table(json);
            $(document).ready(function () {

                //var index =
                var index = 0;
                @{
                    var index = 0;
                }
                for (var key in json) {

                    @* For every key:value in my json, add a new property to my list *@
                    @{
                        Model.Properties.Add(new Property());
                        index = Model.Properties.Count() - 1;
                    }

                    console.log(`${index} for ${key}`);
                    var indexCell = `<td style="display:none"><input name="Properties.Index" type="hidden" value="${index}" /></td>`;
                    var propertyName = `<td><label><input type="hidden" id="Properties_${index}_PropertyName" name="Properties[${index}].PropertyName" value="${key}" />${key}</label></td>`;
                    var dataType = `<td><select class="form-control" id="Properties_${index}_DataType" name="Properties[${index}].DataType">
                                        <option>Select Type . . .</option>
                                        <option>string</option>
                                        <option>bool</option>
                                        <option>int</option>
                                        <option>decimel</option>
                                        <option>DateTime</option>
                                        <option>Complex</option>
                                    </select></td>`;
                    // THIS IS BROKEN
                    var required = `<td><input type="checkbox" id="Properties_${index}_Required" name="Properties[${index}].Required" value="False" /></td>`; 
                    // !! BORKED ^^^^ !!
                    var defaultValue = `<td><input class="form-control" type="text" id="Properties_${index}_DefaultValue" name="Properties[${index}].DefaultValue" value="${json[key]}" /></td>`;
                    var paramMenu = `<td></td>`;
                    html += `<tr>${indexCell}${propertyName}${dataType}${required}${defaultValue}${paramMenu}</tr>`;
                    index = index + 1;
                }
                //var html = `<tr>${propertyName}${dataType}${required}${defaultValue}${paramMenu}</tr>`
                $("#AttributeTable").html(html);
                $("#jsonErrField").html("");
            });
        } catch (e) {
            if (e instanceof SyntaxError) {
                printError(e, true);
            }
            else {
                printError(e, false);
            }
        }
        console.timeEnd('jsonLoadTime');
    }
</script>
